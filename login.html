<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Food Delivery</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }

      .logo {
        display: flex;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        justify-content: center;
      }

      .logo-img {
        width: 140px;
        height: 140px;
        object-fit: contain;
      }

      .tab-buttons {
        display: flex;
        margin-bottom: 30px;
        border-radius: 8px;
        overflow: hidden;
        background: #f0f0f0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .tab-btn.active {
        background: #667eea;
        color: white;
      }

      .form-container {
        display: none;
      }

      .form-container.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: flex;
        gap: 10px;
      }

      .form-row .form-group {
        flex: 1;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .links {
        text-align: center;
        margin-top: 20px;
      }

      .links a {
        color: #667eea;
        text-decoration: none;
        margin: 0 10px;
      }

      .links a:hover {
        text-decoration: underline;
      }

      .alert {
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
      }

      .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Mobile Responsive */
      @media (max-width: 480px) {
        .container {
          padding: 20px;
          margin: 10px;
        }

        .logo {
          width: 100%;
          justify-content: center;
          margin-bottom: 1rem;
        }

        .logo-img {
          width: 132px;
          height: 132px;
        }

        .form-row {
          flex-direction: column;
          gap: 0;
        }

        input,
        select,
        textarea {
          font-size: 16px; /* Prevents zoom on iOS */
        }
      }

      .country-code {
        width: 80px;
      }

      .phone-input {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">
        <img src="lunchbox.png" alt="LunchBox" class="logo-img" />
      </div>

      <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('login')">Login</button>
        <button class="tab-btn" onclick="showTab('signup')">Sign Up</button>
        <button class="tab-btn" onclick="showTab('forgot')">
          Forgot Password
        </button>
      </div>

      <div id="alert" class="alert"></div>

      <!-- Login Form -->
      <div id="login-form" class="form-container active">
        <form id="loginFormElement">
          <div class="form-group">
            <label for="login-email">Email Address</label>
            <input type="email" id="login-email" required />
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" required />
          </div>
          <button type="submit" class="btn" id="login-btn">Login</button>
        </form>
      </div>

      <!-- Sign Up Form -->
      <div id="signup-form" class="form-container">
        <form id="signupFormElement">
          <div class="form-group">
            <label for="signup-name">Full Name</label>
            <input type="text" id="signup-name" required />
          </div>
          <div class="form-group">
            <label>Mobile Number</label>
            <div class="form-row">
              <select id="country-code" class="country-code" required>
                <option value="+60">ðŸ‡²ðŸ‡¾ +60</option>
                <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
              </select>
              <input
                type="tel"
                id="mobile-number"
                class="phone-input"
                placeholder="12 345 6789"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="signup-email">Email Address</label>
            <input type="email" id="signup-email" required />
          </div>
          <div class="form-group">
            <label for="delivery-location">Delivery Location</label>
            <select
              id="delivery-location"
              required
              onchange="toggleAddressField()"
            >
              <option value="">Select Location</option>
              <option value="Exchange 106">Exchange 106</option>
              <option value="TRX">TRX</option>
              <option value="Others">Others</option>
            </select>
          </div>
          <div class="form-group" id="address-field" style="display: none">
            <label for="delivery-address">Full Delivery Address *</label>
            <textarea
              id="delivery-address"
              placeholder="Enter your complete delivery address..."
              required
            ></textarea>
          </div>
          <div class="form-group">
            <label for="signup-password">Password</label>
            <input
              type="password"
              id="signup-password"
              required
              minlength="6"
            />
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" id="confirm-password" required />
          </div>
          <button type="submit" class="btn" id="signup-btn">
            Create Account
          </button>
        </form>
      </div>

      <!-- Forgot Password Form -->
      <div id="forgot-form" class="form-container">
        <form id="forgotFormElement">
          <div class="form-group">
            <label for="forgot-email">Email Address</label>
            <input type="email" id="forgot-email" required />
          </div>
          <button type="submit" class="btn" id="forgot-btn">
            Reset Password
          </button>
        </form>
      </div>

      <div class="links">
        <a href="index.html">Back to Home</a>
      </div>
    </div>

    <script>
      // Google Apps Script Web App URL - Replace with your actual deployed URL
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzABYrIDnqe-bwp05PMctPChln1m0klMBvLAMo9vRPx7VJyrgCH126if7HSZTehqhd4lw/exec";

      // Enhanced fetch function with robust error handling and fallbacks
      async function sendToAppsScript(data) {
        console.log("Sending data:", data);

        try {
          // Primary method: POST with FormData
          const formData = new FormData();
          formData.append("data", JSON.stringify(data));

          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            body: formData,
            mode: "cors",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.text();
          const parsedResult = JSON.parse(result);
          console.log("POST response:", parsedResult);
          return parsedResult;
        } catch (error) {
          console.error("POST request failed:", error);

          // Fallback: try with GET request and URL parameters
          try {
            console.log("Trying GET fallback...");
            const params = new URLSearchParams({ data: JSON.stringify(data) });
            const getResponse = await fetch(`${APPS_SCRIPT_URL}?${params}`, {
              method: "GET",
              mode: "cors",
            });

            if (getResponse.ok) {
              const result = await getResponse.text();
              const parsedResult = JSON.parse(result);
              console.log("GET fallback response:", parsedResult);
              return parsedResult;
            }
          } catch (fallbackError) {
            console.error("GET fallback also failed:", fallbackError);
          }

          throw new Error(
            "Unable to connect to server. Please check your internet connection and try again."
          );
        }
      }

      function showTab(tab) {
        // Hide all forms
        document.querySelectorAll(".form-container").forEach((form) => {
          form.classList.remove("active");
        });

        // Remove active class from all buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected form and activate button
        document.getElementById(`${tab}-form`).classList.add("active");
        event.target.classList.add("active");

        // Clear alert
        hideAlert();
      }

      function toggleAddressField() {
        const location = document.getElementById("delivery-location").value;
        const addressField = document.getElementById("address-field");

        // Always show address field regardless of location choice
        if (location) {
          addressField.style.display = "block";
          document.getElementById("delivery-address").required = true;
        } else {
          addressField.style.display = "none";
          document.getElementById("delivery-address").required = false;
        }
      }

      function showAlert(message, type) {
        const alert = document.getElementById("alert");
        alert.textContent = message;
        alert.className = `alert ${type}`;
        alert.style.display = "block";

        // Auto-hide success messages after 5 seconds
        if (type === "success") {
          setTimeout(() => hideAlert(), 5000);
        }
      }

      function hideAlert() {
        document.getElementById("alert").style.display = "none";
      }

      // Login form handler
      document
        .getElementById("loginFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;

          // Show loading state
          const submitBtn = document.getElementById("login-btn");
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Logging in...";
          submitBtn.disabled = true;

          try {
            const result = await sendToAppsScript({
              action: "login",
              email: email,
              password: password,
            });

            if (result.success) {
              // Store auth data
              localStorage.setItem("userToken", result.token);
              localStorage.setItem("userData", JSON.stringify(result.user));

              showAlert("Login successful! Redirecting...", "success");

              // Redirect to dashboard after delay
              setTimeout(() => {
                window.location.href = "dashboard.html";
              }, 1500);
            } else {
              showAlert(
                result.message || "Login failed. Please try again.",
                "error"
              );
            }
          } catch (error) {
            console.error("Login error:", error);
            showAlert(
              error.message || "Connection error. Please try again.",
              "error"
            );
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Signup form handler
      document
        .getElementById("signupFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get form values
          const name = document.getElementById("signup-name").value.trim();
          const countryCode = document.getElementById("country-code").value;
          const mobile = document.getElementById("mobile-number").value.trim();
          const email = document.getElementById("signup-email").value.trim();
          const deliveryLocation =
            document.getElementById("delivery-location").value;
          const deliveryAddress = document
            .getElementById("delivery-address")
            .value.trim();
          const password = document.getElementById("signup-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          // Validate passwords match
          if (password !== confirmPassword) {
            showAlert("Passwords do not match!", "error");
            return;
          }

          // Validate required fields
          if (
            !name ||
            !mobile ||
            !email ||
            !deliveryLocation ||
            !deliveryAddress ||
            !password
          ) {
            showAlert("Please fill in all required fields.", "error");
            return;
          }

          // Show loading state
          const submitBtn = document.getElementById("signup-btn");
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Creating Account...";
          submitBtn.disabled = true;

          try {
            const result = await sendToAppsScript({
              action: "signup",
              name: name,
              countryCode: countryCode,
              mobile: mobile,
              email: email,
              deliveryLocation: deliveryLocation,
              deliveryAddress: deliveryAddress,
              password: password,
            });

            if (result.success) {
              showAlert(
                "Account created successfully! Please login.",
                "success"
              );
              // Reset form
              this.reset();
              document.getElementById("address-field").style.display = "none";
              // Switch to login tab after delay
              setTimeout(() => {
                showTab("login");
              }, 2000);
            } else {
              showAlert(
                result.message || "Signup failed. Please try again.",
                "error"
              );
            }
          } catch (error) {
            console.error("Signup error:", error);
            showAlert(
              error.message || "Connection error. Please try again.",
              "error"
            );
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Forgot password form handler
      document
        .getElementById("forgotFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("forgot-email").value.trim();

          if (!email) {
            showAlert("Please enter your email address.", "error");
            return;
          }

          const submitBtn = document.getElementById("forgot-btn");
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Sending...";
          submitBtn.disabled = true;

          try {
            const result = await sendToAppsScript({
              action: "forgotPassword",
              email: email,
            });

            if (result.success) {
              showAlert(
                "Password reset instructions sent to your email!",
                "success"
              );
              this.reset();
            } else {
              showAlert(result.message || "Email not found.", "error");
            }
          } catch (error) {
            console.error("Forgot password error:", error);
            showAlert(
              error.message || "Connection error. Please try again.",
              "error"
            );
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Check if user is already logged in
      if (localStorage.getItem("userToken")) {
        window.location.href = "dashboard.html";
      }
    </script>
  </body>
</html>
